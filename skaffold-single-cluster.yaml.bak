apiVersion: skaffold/v4beta7
kind: Config
metadata:
  name: mariadb-k8s-auth

build:
  local:
    push: false
    useBuildkit: true
    concurrency: 1
  artifacts:
  - image: token-validator-api
    context: token-validator-api
    docker:
      dockerfile: Dockerfile
  - image: mariadb-server
    docker:
      dockerfile: Dockerfile.mariadb
      buildArgs:
        BUILDKIT_INLINE_CACHE: "1"
        CMAKE_OPTS: "-DUSE_TOKEN_VALIDATOR_API=ON"
  - image: test-client
    docker:
      dockerfile: Dockerfile.client
      buildArgs:
        BUILDKIT_INLINE_CACHE: "1"

manifests:
  rawYaml:
  - k8s/mariadb-deployment.yaml  # Contains namespace definition
  - k8s/rbac.yaml
  - k8s/token-validator-serviceaccount.yaml
  - k8s/token-validator-configmap.yaml
  - k8s/token-validator-deployment.yaml
  - k8s/token-validator-service.yaml
  - k8s/token-validator-networkpolicy.yaml
  - k8s/test-client.yaml

deploy:
  kubectl: {}
  statusCheck: true
  statusCheckDeadlineSeconds: 300
  logs:
    prefix: podAndContainer

portForward:
- resourceType: service
  resourceName: mariadb
  namespace: mariadb-auth-test
  port: 3306
  localPort: 3306

profiles:
- name: dev
  activation:
  - command: dev
  build:
    artifacts:
    - image: mariadb-server
      docker:
        dockerfile: Dockerfile.mariadb
      sync:
        manual:
        - src: "build/*.so"
          dest: /usr/lib/mysql/plugin/
    - image: test-client
      docker:
        dockerfile: Dockerfile.client
  manifests:
    rawYaml:
    - k8s/mariadb-deployment.yaml
    - k8s/test-client.yaml
  deploy:
    kubectl: {}

- name: debug
  activation:
  - command: debug
  build:
    artifacts:
    - image: mariadb-server
      docker:
        dockerfile: Dockerfile.mariadb
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
    - image: test-client
      docker:
        dockerfile: Dockerfile.client
  patches:
  - op: add
    path: /build/artifacts/0/docker/buildArgs/DEBUG
    value: "1"
